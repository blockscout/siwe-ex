defmodule SiweTest do
  use ExUnit.Case
  doctest Siwe

  test "helper functions are equivalent" do
    msg = "login.xyz wants you to sign in with your Ethereum account:
0xfA151B5453CE69ABf60f0dbdE71F6C9C5868800E

Sign-In With Ethereum Example Statement

URI: https://login.xyz
Version: 1
Chain ID: 1
Nonce: ToTaLLyRanDOM
Issued At: 2021-12-16T20:21:39.911Z
Expiration Time: 2021-12-18T20:21:39.907Z"

    {:ok, res} = Siwe.parse(msg)
    {:ok, msg_2} = Siwe.to_str(res)

    assert(msg_2 == msg)

    sig =
      "0x30893d6bb4b171e540f0ca705c31f2431bdb4e5c712b6e2eb0c87ed6fbfb87e14f1a90da08473bf1e084a41311c0fd2174a676eb53301f9d4703824b5bc2e1b21c"

    bad_sig =
      "0x111111a1abbdf172875e5be41706c50fc3bede8af363b67aefbb543d6d082fb76a22057d7cb6d668ceba883f7d70ab7f1dc015b76b51d226af9d610fa20360ad1c"

    ts = "2021-12-16T20:22:39.911Z"

    # fail on current time
    refute Siwe.verify(res, sig)
    # succeed with valid time
    assert Siwe.verify(res, sig, timestamp: ts)
    # fail with invalid time
    refute Siwe.verify(res, sig, timestamp: "2021-12-19T20:22:39.911Z")
    # fail with bad sig
    refute Siwe.verify(res, bad_sig, timestamp: ts)
    # succeed with valid domain
    assert Siwe.verify(res, sig, domain: "login.xyz", timestamp: ts)
    # fail with invalid domain
    refute Siwe.verify(res, sig, domain: "login.abc", timestamp: ts)
    # succeed with valid nonce
    assert Siwe.verify(res, sig, nonce: "ToTaLLyRanDOM", timestamp: ts)
    # fail with invalid nonce
    refute Siwe.verify(res, sig, nonce: "totallyrandom", timestamp: ts)
    # succeed with all
    assert Siwe.verify(res, sig, domain: "login.xyz", nonce: "ToTaLLyRanDOM", timestamp: ts)
  end

  # TODO: Add test for time using on-fly-generated message and sig, requiring local key to test?
  test "verifies message and signature" do
    msg = "login.xyz wants you to sign in with your Ethereum account:
0xfA151B5453CE69ABf60f0dbdE71F6C9C5868800E

Sign-In With Ethereum Example Statement

URI: https://login.xyz
Version: 1
Chain ID: 1
Nonce: ToTaLLyRanDOM
Issued At: 2021-12-17T00:38:39.834Z"

    sig =
      "0x8d1327a1abbdf172875e5be41706c50fc3bede8af363b67aefbb543d6d082fb76a22057d7cb6d668ceba883f7d70ab7f1dc015b76b51d226af9d610fa20360ad1c"

    {:ok, res} = Siwe.parse_if_valid(msg, sig)
    assert(res.domain == "login.xyz")
    assert(res.address == "0xfA151B5453CE69ABf60f0dbdE71F6C9C5868800E")
    assert(res.uri == "https://login.xyz")
    assert(res.version == "1")
    assert(res.chain_id == 1)
    assert(res.nonce == "ToTaLLyRanDOM")
    assert(res.issued_at == "2021-12-17T00:38:39.834Z")
    assert(res.expiration_time == nil)
    assert(res.not_before == nil)
    assert(res.request_id == nil)
    assert(res.resources == [])
  end

  test "rejects bad signature" do
    msg = "login.xyz wants you to sign in with your Ethereum account:
0xfA151B5453CE69ABf60f0dbdE71F6C9C5868800E

Sign-In With Ethereum Example Statement

URI: https://login.xyz
Version: 1
Chain ID: 1
Nonce: ToTaLLyRanDOM
Issued At: 2021-12-17T00:38:39.834Z"

    sig =
      "0x8d1327a1abbdf172875e5be41706c50fc3bede8af363b67aefbb543d6d082fb76a22057d7cb6d668ceba883f7d70ab7f1dc015b76b51d226af9d610fa20360ad1d"

    {:error, _} = Siwe.parse_if_valid(msg, sig)
  end

  test "rejects expired message with valid signature" do
    msg = "login.xyz wants you to sign in with your Ethereum account:
0xfA151B5453CE69ABf60f0dbdE71F6C9C5868800E

Sign-In With Ethereum Example Statement

URI: https://login.xyz
Version: 1
Chain ID: 1
Nonce: ToTaLLyRanDOM
Issued At: 2021-12-16T20:21:39.911Z
Expiration Time: 2021-12-18T20:21:39.907Z"

    sig =
      "0x30893d6bb4b171e540f0ca705c31f2431bdb4e5c712b6e2eb0c87ed6fbfb87e14f1a90da08473bf1e084a41311c0fd2174a676eb53301f9d4703824b5bc2e1b21c"

    {:error, _} = Siwe.parse_if_valid(msg, sig)
  end

  test "verifies smart wallet signature" do
    msg = "royal.market wants you to sign in with your Ethereum account:
0xc51692f723E098BeC6507a7DE544A4076083aB99

Sign in to Royal. By signing in you agree to our terms of use.

URI: https://royal.market
Version: 1
Chain ID: 84532
Nonce: FxwnX1ADyOv
Issued At: 2024-08-14T01:32:42.864Z
Resources:
- https://royal.io/legal/tos"

    assert {:ok, msg} = Siwe.parse(msg)

    sig =
      "0x000000000000000000000000ca11bde05977b3631167028862be2a173976ca110000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000028000000000000000000000000000000000000000000000000000000000000001e482ad56cb0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000ba5ed0c6aa8c49038f819e587e2633c4a9f428a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e43ffba36f000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000407931cee16eefaff92deaa7b1f7cf05a3b751e8182df16e3ac6fda64fb523f7b16a9fb505488da6a5852aaca31a9d8c9fc7a4de88f45ad36d9c98ebc59f3d4e7f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000170000000000000000000000000000000000000000000000000000000000000001213576070033a5da5c70d99171d2fb33f3094b8947062504ba04b7b47462c1913c9f0cbab377f812d18d0a0f2290e2b04ab1bb25e21943f12066714045ea97d90000000000000000000000000000000000000000000000000000000000000025f198086b2db17256731bc456673b96bcef23f51d1fbacdd7c4379ef65465572f1d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008a7b2274797065223a22776562617574686e2e676574222c226368616c6c656e6765223a22753374593031343365756f4f4e6d713763396a6a724d424644537157304b4542307a6b69467056484a3945222c226f726967696e223a2268747470733a2f2f6b6579732e636f696e626173652e636f6d222c2263726f73734f726967696e223a66616c73657d000000000000000000000000000000000000000000006492649264926492649264926492649264926492649264926492649264926492"

    assert Siwe.verify(msg, sig, rpc_url: "https://sepolia.base.org") == true
  end

  test "verifies deployed smart wallet signature on base-sepolia" do
    msg = "royal.market wants you to sign in with your Ethereum account:
0xB323dC84085eC25FF635CcA7c48B7484d9A78C7E

Sign in to Royal. By signing in you agree to our terms of use.

URI: https://royal.market
Version: 1
Chain ID: 84532
Nonce: oPl5AulKaU2
Issued At: 2024-08-14T00:58:29.232Z
Resources:
- https://royal.io/legal/tos"

    assert {:ok, msg} = Siwe.parse(msg)

    sig =
      "0x0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000170000000000000000000000000000000000000000000000000000000000000001ae6abc8a4fb2581660a282be473092b7c5eb89bc6685cd6ff0c5e651a509a0f4680b9172a15befa76ce1786e6ec5f55b978c2e30fa8df43dcb144a198f5eb9640000000000000000000000000000000000000000000000000000000000000025f198086b2db17256731bc456673b96bcef23f51d1fbacdd7c4379ef65465572f1d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008a7b2274797065223a22776562617574686e2e676574222c226368616c6c656e6765223a226c395a566b307a79344a776d5a4f724d4e6c6831684c756a6c774e6864516d764f793857467a4f785a5651222c226f726967696e223a2268747470733a2f2f6b6579732e636f696e626173652e636f6d222c2263726f73734f726967696e223a66616c73657d00000000000000000000000000000000000000000000"

    assert Siwe.verify(msg, sig, rpc_url: "https://sepolia.base.org") == true
  end
end
